---
title: "nhanes_model_stl2137"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(caret)
library(ModelMetrics)
library(glmnet)
set.seed(13)
```

```{r}
train_dat <- read_csv("./training_data_final.csv") %>% 
  mutate(
    dbd100 = as.factor(dbd100),
    drqsprep = as.factor(drqsprep),
    drqsdiet = as.factor(drqsdiet),
    dr1_300 = as.factor(dr1_300),
    drd340 = as.factor(drd340),
    drd360 = as.factor(drd360),
    bpq020 = as.factor(bpq020),
    cdq001 = as.factor(cdq001),
    hsd010 = as.factor(hsd010),
    diq010 = as.factor(diq010),
    dbq700 = as.factor(dbq700),
    fsd032a = as.factor(fsd032a),
    fsd032c = as.factor(fsd032c),
    fsdhh = as.factor(fsdhh),
    hiq270 = as.factor(hiq270),
    paq605 = as.factor(paq605),
    smq020 = as.factor(smq020),
    riagendr = as.factor(riagendr),
    ridreth1 = as.factor(ridreth1),
    ridreth3 = as.factor(ridreth3),
    dmdborn4 = as.factor(dmdborn4)
  )

test_dat <- read_csv("./test_data_final.csv") %>% 
  mutate(
    dbd100 = as.factor(dbd100),
    drqsprep = as.factor(drqsprep),
    drqsdiet = as.factor(drqsdiet),
    dr1_300 = as.factor(dr1_300),
    drd340 = as.factor(drd340),
    drd360 = as.factor(drd360),
    bpq020 = as.factor(bpq020),
    cdq001 = as.factor(cdq001),
    hsd010 = as.factor(hsd010),
    diq010 = as.factor(diq010),
    dbq700 = as.factor(dbq700),
    fsd032a = as.factor(fsd032a),
    fsd032c = as.factor(fsd032c),
    fsdhh = as.factor(fsdhh),
    hiq270 = as.factor(hiq270),
    paq605 = as.factor(paq605),
    smq020 = as.factor(smq020),
    riagendr = as.factor(riagendr),
    ridreth1 = as.factor(ridreth1),
    ridreth3 = as.factor(ridreth3),
    dmdborn4 = as.factor(dmdborn4)
  )

# Creating x and y Variables for Test and Training Data
y_train <- train_dat$lbdldl
x_train <- model.matrix(lbdldl ~ ., train_dat)[, -(1:2)]

y_test <- test_dat$lbdldl
x_test <- model.matrix(lbdldl ~ ., test_dat)[, -(1:2)]

# creating training controls for 10-fold CV
control1 <- trainControl(method = "cv", number = 10)
control2 <- trainControl(method = "loocv")
```

### Linear Model with 10-fold CV

```{r}
linear_fit <- train(lbdldl ~ .,
                   data = train_dat,
                   method = "lm",
                   trControl = control1)

summary(linear_fit)

lm_prediction <- predict(linear_fit, newdata = test_dat)
lm_mse <- mse(y_test, lm_prediction)
```

### Writing Functions for Models 

```{r}
### Function to run model
model_function <- function(method_sel, alpha_sel, lower_bound, upper_bound, control_sel){
  model_fit <- train(lbdldl ~ .,
                   data = train_dat,
                   method = method_sel,
                   tuneGrid = expand.grid(alpha = alpha_sel, 
                                          lambda = exp(seq(lower_bound, upper_bound, length = 100))),
                   preProc = c("center", "scale"),
                   trControl = control_sel
)
  return(model_fit)
}

### Function to Plot
plot_function <- function(model_fit){
  model_plot <- plot(model_fit, xTrans = function(x_train) log(x_train))
  return(model_plot)
}

### Function to Output Lambda 
lambda_function <- function(model_fit){
  lambda_fit <- model_fit$bestTune$lambda
  return(lambda_fit)
}

### Function to Derive Number of Coefficients
coef_function <- function(model_fit){
  coef_estimates_model <- coef(model_fit$finalModel, model_fit$bestTune$lambda)
num_coef_model <- sum(as.vector(coef_estimates_model) != 0)
return(num_coef_model)
}
```

### Prediction Functions

```{r}
predict_mse_function <- function(model_fit){
  predict_model_fit <- predict(model_fit, newdata = test_dat)
  model_mse <- mse(y_test, predict_model_fit)
  return(model_mse)
}
```


### Lasso Model with 10-fold CV
```{r}
lasso_fit <- model_function("glmnet", 1, 0, 5, control1)
lasso_plot <- plot_function(lasso_fit)
lambda_function(lasso_fit)
coef_function(lasso_fit)
lasso_mse <- predict_mse_function(lasso_fit)
```

### Ridge Model with 10-fold CV 
```{r}
ridge_fit <- model_function("glmnet", 0, 0, 5, control1)
ridge_plot <- plot_function(ridge_fit)
lambda_function(ridge_fit)
coef_function(ridge_fit)
ridge_mse <- predict_mse_function(ridge_fit)
```

### Elastic Net Model (alpha = 0.75) with 10-fold CV 
```{r}
elast_fit <- model_function("glmnet", 0.75, 0, 5, control1)
elast_plot <- plot_function(elast_fit)
lambda_function(elast_fit)
coef_function(elast_fit)
elast_mse <- predict_mse_function(elast_fit)
```

### Elastic Net Model (alpha = 0.25) with 10-fold CV
```{r}
elast_25_fit <- model_function("glmnet", 0.25, 0, 5, control1)
elast_25_plot <- plot_function(elast_25_fit)
lambda_function(elast_25_fit)
coef_function(elast_25_fit)
elast_25_mse <- predict_mse_function(elast_25_fit)
```

### Comparing models

```{r}
resamp <- resamples(list(lm = linear_fit,
                         lasso = lasso_fit, 
                         ridge = ridge_fit, 
                         elastic_net_75 = elast_fit, 
                         elastic_net_25 = elast_25_fit))
summary(resamp)

bwplot(resamp, metric = "RMSE")
```

# LOOCV

### Linear Model with LOOCV 
```{r}
linear_loocv <- train(lbdldl ~ .,
                   data = train_dat,
                   method = "lm",
                   trControl = control2)

summary(linear_loocv)

lm_prediction_loocv <- predict(linear_loocv, newdata = test_dat)
lm_mse <- mse(y_test, lm_prediction_loocv)
```


### Lasso Model with LOOCV
```{r}
lasso_loocv <- model_function("glmnet", 1, -1, 5, control2)
lasso_plot_loocv <- plot_function(lasso_loocv)
lambda_function(lasso_loocv)
coef_function(lasso_loocv)
lasso_mse_loocv <- predict_mse_function(lasso_loocv)
```

### Ridge Model with LOOCV 
```{r}
ridge_loocv <- model_function("glmnet", 0, -1, 5, control2)
ridge_plot_loocv <- plot_function(ridge_loocv)
lambda_function(ridge_loocv)
coef_function(ridge_loocv)
ridge_mse_loocv <- predict_mse_function(ridge_loocv)
```

### Elastic Net Model (alpha = 0.75) with LOOCV 
```{r}
elast_loocv <- model_function("glmnet", 0.75, -1, 5, control2)
elast_plot_loocv <- plot_function(elast_loocv)
lambda_function(elast_loocv)
coef_function(elast_loocv)
elast_mse_loocv <- predict_mse_function(elast_loocv)
```

### Elastic Net Model (alpha = 0.25) with LOOCV
```{r}
elast_25_loocv <- model_function("glmnet", 0.25, -1, 5, control2)
elast_25_plot_loocv <- plot_function(elast_25_loocv)
lambda_function(elast_25_loocv)
coef_function(elast_25_loocv)
elast_25_mse_loocv <- predict_mse_function(elast_25_loocv)
```

### Comparing models

```{r}
resamp_loocv <- resamples(list(linear = linear_loocv,
                               lasso_loocv = lasso_loocv,
               ridge_loocv = ridge_loocv,
               elastic_net_75 = elast_loocv,
               elastic_net_25 = elast_25_loocv))

summary(resamp_loocv)

bwplot(resamp_loocv, metric = "RMSE", xlim = c(0, 50)) 
```